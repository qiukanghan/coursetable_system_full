import{_ as e,r as l,o as a,k as t,l as o,a as s,m as u,d as n,c,w as d,p as r,q as i,F as f,n as p,f as v,i as m,t as y,h as g,b as _,e as h,u as k,v as I,s as x,x as D,g as V,I as b}from"./index-BYGVDGSr.js";import{o as N,r as w,_ as O}from"./uni-popup.p_DJac7v.js";import{r as C,u as W}from"./xlsx.CR_wQmuH.js";const $=e({__name:"home",setup(e){const $=l(!1),S=l("");let U=null;const j=l("周课表"),A=l("日课表"),L=l(null),E=l([]),F=l(""),H=l(!0),T=l(0),B=l([]);function M(){$.value=!1}const P=()=>{v({url:`http://localhost:3001/courseList?studentId=${F.value}`,method:"GET",success:e=>{200===e.statusCode?(E.value=e.data,R(),console.log("课程列表加载成功，共",E.value.length,"门课程"),J(),K()):console.error("获取课程列表失败:",e)},fail:e=>{console.error("网络请求失败:",e)}})},q=e=>E.value.filter((l=>parseInt(l.dayOfWeek.split("-")[0])===e)),G=e=>{const l=e.split("-");return`${l[1]}:${l[2]}`},R=()=>{B.value=E.value.filter((e=>parseInt(e.dayOfWeek.split("-")[0])===T.value)),console.log("今日课程数量:",B.value.length)},z=e=>{if(!e||"string"!=typeof e)return null;const[l,a,t]=e.split("-").map(Number);if(isNaN(l)||isNaN(a)||isNaN(t))return console.warn("无效的时间格式:",e),null;if(l<1||l>7||a<0||a>23||t<0||t>59)return console.warn("时间值超出范围:",e),null;const o=new Date,s=new Date(o);let u=l%7;return 0===u&&(u=7),u<o.getDay()?s.setDate(s.getDate()+7-(o.getDay()-u)):u===o.getDay()?(s.getHours()>a||s.getHours()===a&&s.getMinutes()>t)&&s.setDate(s.getDate()+7):s.setDate(s.getDate()+(u-o.getDay())),s.setHours(a,t,0),s>o?s:null},J=()=>{U&&(clearInterval(U),console.log("清除已有提醒定时器")),0!==B.value.length?(U=setInterval((()=>{console.log("检查课程提醒..."),K()}),6e4),console.log("已设置课程提醒定时器，每分钟检查一次")):console.log("今日没有课程，不设置提醒")},K=()=>{console.log("立即检查课程提醒...");const e=new Date;for(const l of B.value){const a=z(l.dayOfWeek);if(!a){console.warn("无法解析课程时间:",l.dayOfWeek);continue}const t=Math.floor((a-e)/6e4);if(t>=0&&t<=30){console.log(`课程"${l.courseName}"将在${t}分钟后开始，触发提醒`),S.value=l.courseName,$.value=!0;break}}},Q=l({courseName:"",dayOfWeek:"",location:"",teacher:"",courseId:"",categoryId:""}),X=(e,l)=>{if(l>=e.length)return x({title:`已完成${e.length}条课程添加`,icon:"success"}),void P();v({url:`http://localhost:3001/courseList?studentId=${F.value}`,method:"POST",data:e[l],success:a=>X(e,l+1),fail:()=>X(e,l+1)})};return N((e=>{F.value=e.studentId,console.log("当前学生ID:",F.value)})),a((()=>{console.log("页面挂载，初始化课程表");const e=new Date;T.value=0===e.getDay()?7:e.getDay(),console.log("今日星期:",T.value),P(),console.log("当前时间:",e.toLocaleString())})),t((()=>{U&&(clearInterval(U),console.log("页面卸载，清除提醒定时器"))})),o((()=>{console.log("今日课程列表更新，重新设置提醒"),J()})),(e,l)=>{const a=m,t=y,o=g,N=V,U=b,E=w(s("uni-popup"),O);return _(),u(f,null,[n(a,{class:"pageBg"}),$.value?(_(),c(a,{key:0,class:"reminder-box",style:r({display:$.value?"flex":"none"})},{default:d((()=>[n(t,{class:"reminder-text"},{default:d((()=>[h("30分钟后有课程："+k(S.value),1)])),_:1}),n(o,{class:"reminder-close",onClick:M},{default:d((()=>[h("×")])),_:1})])),_:1},8,["style"])):i("",!0),n(t,{class:"title"},{default:d((()=>[h(k(j.value),1)])),_:1}),n(o,{class:"btn-change btn-font",onClick:l[0]||(l[0]=e=>(H.value=!H.value,j.value=H.value?"周课表":"日课表",void(A.value=H.value?"日课表":"周课表")))},{default:d((()=>[h("查看"+k(A.value),1)])),_:1}),n(o,{class:"btn-add btn-font",onClick:l[1]||(l[1]=e=>{L.value.open("center")})},{default:d((()=>[h("添加课表")])),_:1}),n(o,{class:"btn-exit btn-font",onClick:l[2]||(l[2]=e=>{p({url:"/pages/index/index"})})},{default:d((()=>[h("退出登录")])),_:1}),H.value?(_(),c(a,{key:1,class:"container"},{default:d((()=>[n(a,{class:"week-container"},{default:d((()=>[(_(),u(f,null,I(7,(e=>n(a,{class:"week-column",key:e},{default:d((()=>[n(a,{class:"week-title"},{default:d((()=>[h(k(["周一","周二","周三","周四","周五","周六","周日"][e-1]),1)])),_:2},1024),(_(!0),u(f,null,I(q(e),((e,l)=>(_(),c(a,{class:"course-item",key:l,style:r({backgroundColor:"1"===e.categoryId?"#e6f3ff":"white"})},{default:d((()=>[n(a,{class:"course-title"},{default:d((()=>[h("课程名称："+k(e.courseName),1)])),_:2},1024),n(a,null,{default:d((()=>[h("时间："+k(G(e.dayOfWeek)),1)])),_:2},1024),n(a,null,{default:d((()=>[h("地点："+k(e.location),1)])),_:2},1024),n(a,null,{default:d((()=>[h("讲师："+k(e.teacher),1)])),_:2},1024),n(a,null,{default:d((()=>[h("课程ID："+k(e.courseId),1)])),_:2},1024)])),_:2},1032,["style"])))),128))])),_:2},1024))),64))])),_:1})])),_:1})):(_(),c(a,{key:2,class:"container day-view"},{default:d((()=>[n(a,{class:"day-header"},{default:d((()=>[n(t,{class:"day-title"},{default:d((()=>[h("今日（"+k(["周一","周二","周三","周四","周五","周六","周日"][T.value-1])+"）课表",1)])),_:1})])),_:1}),n(a,{class:"day-course-container"},{default:d((()=>[(_(!0),u(f,null,I(B.value,((e,l)=>(_(),c(a,{class:"course-item",key:l,style:r({backgroundColor:"1"===e.categoryId?"#e6f3ff":"white"})},{default:d((()=>[n(a,{class:"course-title"},{default:d((()=>[h("课程名称："+k(e.courseName),1)])),_:2},1024),n(a,null,{default:d((()=>[h("时间："+k(G(e.dayOfWeek)),1)])),_:2},1024),n(a,null,{default:d((()=>[h("地点："+k(e.location),1)])),_:2},1024),n(a,null,{default:d((()=>[h("讲师："+k(e.teacher),1)])),_:2},1024),n(a,null,{default:d((()=>[h("课程ID："+k(e.courseId),1)])),_:2},1024)])),_:2},1032,["style"])))),128)),0===B.value.length?(_(),c(a,{key:0,class:"empty-state"},{default:d((()=>[h(" 今日没有课程安排 ")])),_:1})):i("",!0)])),_:1})])),_:1})),n(E,{ref_key:"popupAdd",ref:L,type:"center","is-mask-click":!0},{default:d((()=>[n(a,{class:"popContainer"},{default:d((()=>[n(N,null,{default:d((()=>[h("课程名：")])),_:1}),n(U,{type:"text",modelValue:Q.value.courseName,"onUpdate:modelValue":l[3]||(l[3]=e=>Q.value.courseName=e),placeholder:"请输入课程名"},null,8,["modelValue"]),n(N,null,{default:d((()=>[h("时间：")])),_:1}),n(U,{type:"text",modelValue:Q.value.dayOfWeek,"onUpdate:modelValue":l[4]||(l[4]=e=>Q.value.dayOfWeek=e),placeholder:"周一十点零分：1-10-00"},null,8,["modelValue"]),n(N,null,{default:d((()=>[h("地点：")])),_:1}),n(U,{type:"text",modelValue:Q.value.location,"onUpdate:modelValue":l[5]||(l[5]=e=>Q.value.location=e),placeholder:"一号楼c201"},null,8,["modelValue"]),n(N,null,{default:d((()=>[h("老师：")])),_:1}),n(U,{type:"text",modelValue:Q.value.teacher,"onUpdate:modelValue":l[6]||(l[6]=e=>Q.value.teacher=e),placeholder:"请输入老师名"},null,8,["modelValue"]),n(N,null,{default:d((()=>[h("课程编号：")])),_:1}),n(U,{type:"text",modelValue:Q.value.courseId,"onUpdate:modelValue":l[7]||(l[7]=e=>Q.value.courseId=e),placeholder:"请输入课程编号"},null,8,["modelValue"]),n(N,null,{default:d((()=>[h("是否必修：")])),_:1}),n(U,{type:"text",modelValue:Q.value.categoryId,"onUpdate:modelValue":l[8]||(l[8]=e=>Q.value.categoryId=e),placeholder:"是：1，否：0"},null,8,["modelValue"]),n(o,{class:"btn-font btn-comfirmAdd",onClick:l[9]||(l[9]=e=>{v({url:`http://localhost:3001/courseList?studentId=${F.value}`,method:"POST",data:Q.value,success:e=>{201===e.statusCode?(x({title:"添加成功",icon:"success"}),P()):x({title:"添加失败",icon:"none"})},fail:()=>x({title:"网络异常，请检查连接",icon:"none"})})})},{default:d((()=>[h("确认添加")])),_:1}),n(o,{class:"btn-font btn-comfirmAdd",onClick:l[10]||(l[10]=e=>{D({count:1,extension:[".xlsx",".xls"],success:e=>{const l=e.tempFiles[0];if(!l)return;const a=new FileReader;a.onload=e=>{try{const l=e.target.result,a=C(l,{type:"binary"}),t=a.Sheets[a.SheetNames[0]],o=W.sheet_to_json(t).map((e=>({courseName:e.课程名称||"",dayOfWeek:e.时间||"",location:e.地点||"",teacher:e.老师||"",courseId:e.课程编号||"",categoryId:"必修"===e.是否必修?"1":"0"})));X(o,0)}catch(l){console.error("Excel解析错误:",l),x({title:"Excel解析失败",icon:"none"})}},a.onerror=()=>x({title:"文件读取失败",icon:"none"}),a.readAsBinaryString(l)},fail:()=>x({title:"选择文件失败",icon:"none"})})})},{default:d((()=>[h("excel批量添加")])),_:1})])),_:1})])),_:1},512)],64)}}},[["__scopeId","data-v-57993103"]]);export{$ as default};
